name: Check for Goby Updates

on:
  schedule:
    # æ¯ä¸‰å¤© UTC æ—¶é—´ 12:00 è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 20:00ï¼‰
    - cron: '0 12 */3 * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼Œç”¨äºåç»­ diff æ¯”è¾ƒ

      - name: 2. è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "PKGNAME=goby" >> $GITHUB_ENV
          echo "PKGBUILD_PATH=./goby-community/PKGBUILD" >> $GITHUB_ENV
          echo "PKGDIR=./goby-community" >> $GITHUB_ENV

      - name: 3. è·å–æœ€æ–°ç‰ˆæœ¬å·
        id: get_version
        run: |
          API_URL="https://gobies.org/download/release?type=full_url_linux&id=319"
          NEW_VERSION=$(curl -sIL -H 'Referer: https://gobysec.net/' "$API_URL" | grep -i 'location: ' | tail -1 | sed -n 's|.*/\([0-9]\+\.[0-9]\+\.[0-9]\+\).*|\1|p')

          if [ -z "$NEW_VERSION" ]; then
            echo "âŒ æ— æ³•è·å–ç‰ˆæœ¬å·"
            exit 1
          fi
          echo "è·å–åˆ°æœ€æ–°ç‰ˆæœ¬: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: 4. è·å–å½“å‰ PKGBUILD ä¸­çš„ç‰ˆæœ¬
        id: current_version
        run: |
          CURRENT_VERSION=$(grep -m1 '^pkgver=' ${{ env.PKGBUILD_PATH }} | cut -d= -f2)
          echo "å½“å‰ PKGBUILD ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: 5. æ¯”è¾ƒç‰ˆæœ¬
        id: version_diff
        run: |
          if [ "${{ steps.get_version.outputs.new_version }}" = "${{ steps.current_version.outputs.current_version }}" ]; then
            echo "ğŸ”„ ç‰ˆæœ¬æœªæ›´æ–°ï¼Œæ— éœ€æ“ä½œã€‚"
            echo "has_update=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬: ${{ steps.current_version.outputs.current_version }} -> ${{ steps.get_version.outputs.new_version }}"
            echo "has_update=true" >> $GITHUB_OUTPUT
          fi

      - name: 6. ä¸‹è½½æ–°ç‰ˆæœ¬å¹¶è®¡ç®— SHA256ï¼ˆä»…åœ¨æ›´æ–°æ—¶è¿è¡Œï¼‰
        if: steps.version_diff.outputs.has_update == 'true'
        run: |
          DOWNLOAD_URL="https://goby-storage-public.oss-cn-beijing.aliyuncs.com/${{ env.NEW_VERSION }}/goby-linux-x64-${{ env.NEW_VERSION }}-Community.zip"

          echo "æ­£åœ¨ä¸‹è½½æ–‡ä»¶ä»¥è®¡ç®—æ ¡éªŒå’Œ..."
          curl -k -L -H 'Referer: https://gobysec.net/' -o /tmp/goby-new.zip "$DOWNLOAD_URL"

          NEW_SHA256=$(sha256sum /tmp/goby-new.zip | cut -d' ' -f1)
          echo "æ–°æ–‡ä»¶ SHA256: $NEW_SHA256"
          echo "NEW_SHA256=$NEW_SHA256" >> $GITHUB_ENV

          FILE_SIZE=$(stat -c%s /tmp/goby-new.zip)
          echo "æ–‡ä»¶å¤§å°: $((FILE_SIZE / 1048576)) MB"

          rm -f /tmp/goby-new.zip

      - name: 7. æ›´æ–° PKGBUILD æ–‡ä»¶ï¼ˆä»…åœ¨æ›´æ–°æ—¶è¿è¡Œï¼‰
        if: steps.version_diff.outputs.has_update == 'true'
        run: |
          # å¤‡ä»½åŸæ–‡ä»¶
          cp ${{ env.PKGBUILD_PATH }} ${{ env.PKGBUILD_PATH }}.bak

          # æ›´æ–° pkgver
          sed -i "s/^pkgver=.*/pkgver=${{ env.NEW_VERSION }}/" ${{ env.PKGBUILD_PATH }}

          sed -i "/^sha256sums=(/,/^)/ {0,/'[^']*'/s/'[^']*'/'$NEW_SHA256'/}" ${{ env.PKGBUILD_PATH }}

          echo "PKGBUILD æ›´æ–°å®Œæˆã€‚"
          echo "æ›´æ–°æ‘˜è¦ï¼š"
          echo "  pkgver: ${{ steps.current_version.outputs.current_version }} -> ${{ env.NEW_VERSION }}"
          echo "  sha256sums: -> $NEW_SHA256"

      - name: 8. æäº¤æ›´æ”¹ï¼ˆä»…åœ¨æ›´æ–°æ—¶è¿è¡Œï¼‰
        if: steps.version_diff.outputs.has_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add ${{ env.PKGBUILD_PATH }}
          git commit -m "goby-community: update to ${{ env.NEW_VERSION }}"
          git push

      - name: 9. è¾“å‡ºç»“æœæ‘˜è¦
        run: |
          if [ "${{ steps.version_diff.outputs.has_update }}" = "true" ]; then
            echo "âœ… å·²å‘ç°æ›´æ–°å¹¶è‡ªåŠ¨æäº¤ï¼"
            echo "::notice title=Goby-Community æ›´æ–°å°±ç»ª::æ–°ç‰ˆæœ¬ ${{ env.NEW_VERSION }} å·²å°±ç»ªï¼Œè¯·åŒæ­¥ä»“åº“å¹¶æ¨é€åˆ° AURã€‚"
          else
            echo "â„¹ï¸ æš‚æ— æ›´æ–°ã€‚"
          fi
